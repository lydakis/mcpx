name: release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  goreleaser:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      - name: Validate release secrets
        env:
          APPLE_DEVELOPER_ID_CERTIFICATE_P12_BASE64: ${{ secrets.APPLE_DEVELOPER_ID_CERTIFICATE_P12_BASE64 }}
          APPLE_DEVELOPER_ID_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_DEVELOPER_ID_CERTIFICATE_PASSWORD }}
          APPLE_DEVELOPER_ID_APPLICATION: ${{ secrets.APPLE_DEVELOPER_ID_APPLICATION }}
          APP_STORE_CONNECT_API_KEY_P8: ${{ secrets.APP_STORE_CONNECT_API_KEY_P8 }}
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          GORELEASER_TOKEN: ${{ secrets.GORELEASER_TOKEN }}
        run: |
          if [[ -z "${GORELEASER_TOKEN}" ]]; then
            echo "Missing required secret: GORELEASER_TOKEN" >&2
            exit 1
          fi

          missing_notarization=0
          for key in \
            APPLE_DEVELOPER_ID_CERTIFICATE_P12_BASE64 \
            APPLE_DEVELOPER_ID_CERTIFICATE_PASSWORD \
            APPLE_DEVELOPER_ID_APPLICATION \
            APP_STORE_CONNECT_API_KEY_P8 \
            APP_STORE_CONNECT_KEY_ID \
            APP_STORE_CONNECT_ISSUER_ID
          do
            if [[ -z "${!key:-}" ]]; then
              echo "warning: notarization secret not set: ${key}" >&2
              missing_notarization=1
            fi
          done
          if [[ "${missing_notarization}" -ne 0 ]]; then
            echo "warning: macOS notarization will be skipped for this release." >&2
          fi

      - name: Normalize App Store Connect key
        env:
          APP_STORE_CONNECT_API_KEY_P8: ${{ secrets.APP_STORE_CONNECT_API_KEY_P8 }}
        run: |
          if [[ -z "${APP_STORE_CONNECT_API_KEY_P8}" ]]; then
            exit 0
          fi

          normalized="$(printf '%b\n' "${APP_STORE_CONNECT_API_KEY_P8}")"
          if printf '%s' "${normalized}" | base64 --decode >/dev/null 2>&1; then
            key_payload="$(printf '%s' "${normalized}" | tr -d '\r\n')"
          else
            key_payload="$(printf '%s' "${normalized}" | base64 | tr -d '\r\n')"
          fi

          {
            echo "APP_STORE_CONNECT_API_KEY_P8_NORMALIZED<<EOF"
            printf '%s\n' "${key_payload}"
            echo "EOF"
          } >> "${GITHUB_ENV}"

      - name: GoReleaser
        uses: goreleaser/goreleaser-action@v7
        with:
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HOMEBREW_TAP_GITHUB_TOKEN: ${{ secrets.GORELEASER_TOKEN }}
          APPLE_DEVELOPER_ID_CERTIFICATE_P12_BASE64: ${{ secrets.APPLE_DEVELOPER_ID_CERTIFICATE_P12_BASE64 }}
          APPLE_DEVELOPER_ID_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_DEVELOPER_ID_CERTIFICATE_PASSWORD }}
          APPLE_DEVELOPER_ID_APPLICATION: ${{ secrets.APPLE_DEVELOPER_ID_APPLICATION }}
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_P8_NORMALIZED: ${{ env.APP_STORE_CONNECT_API_KEY_P8_NORMALIZED }}

  publish_wrappers:
    needs: goreleaser
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Validate wrapper publish secrets
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          PYPI_API_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          if [[ -z "${NPM_TOKEN}" ]]; then
            echo "Missing required secret: NPM_TOKEN" >&2
            exit 1
          fi
          if [[ -z "${PYPI_API_TOKEN}" ]]; then
            echo "Missing required secret: PYPI_API_TOKEN" >&2
            exit 1
          fi

      - name: Resolve release version
        run: echo "RELEASE_VERSION=${GITHUB_REF_NAME#v}" >> "${GITHUB_ENV}"

      - name: Publish npm wrapper
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: ./scripts/publish_npm_wrapper.sh "${RELEASE_VERSION}"

      - name: Publish PyPI wrapper
        env:
          PYPI_API_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        run: ./scripts/publish_pypi_wrapper.sh "${RELEASE_VERSION}"
